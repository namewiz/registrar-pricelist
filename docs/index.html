<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registrar TLD Price List</title>
  <style>
    :root {
      --bg: #fff;
      --text: #0f172a;
      --muted: #6b7280;
      --line: #e5e7eb;
      --ring: #d1d5db;
      --shadow: 0 10px 30px rgba(0, 0, 0, .06);
      --accent: #2563eb;
      --accent-tint: #eff6ff;
    }

    * { box-sizing: border-box }
    [hidden] { display: none !important; }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      font: 16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .wrap {
      max-width: 1100px;
      width: 100%;
      margin: 48px auto 0;
      padding: 0 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    h1 {
      font-weight: 700;
      font-size: 36px;
      letter-spacing: -.02em;
      margin: 0 0 8px
    }

    .sub { color: var(--muted); margin-bottom: 20px }

    .search { display:flex; align-items:center; gap:12px; background:#f8fafc; border:1px solid var(--ring); border-radius:14px; padding:12px 14px; box-shadow: var(--shadow); }
    .search input { border:0; background:transparent; flex:1; outline:none; font-size:16px; color:var(--text); }
    .search button.icon { border:0; background:#eef2f7; width:32px; height:32px; border-radius:8px; display:grid; place-items:center; cursor:pointer }
    .search svg { width:18px; height:18px }

    .summary { color: var(--muted); margin: 12px 0 10px; font-size: 14px; }

    .table-wrap { margin-top: 10px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; border: 1px solid var(--line); }
    thead th { position: sticky; top: 0; background: #f8fafc; color: var(--muted); font-weight: 600; text-align: left; padding: 8px 10px; border-bottom: 1px solid var(--line); }
    tbody td { padding: 8px 10px; border-top: 1px solid var(--line); font-variant-numeric: tabular-nums; }
    tbody tr:nth-child(even) td { background: #fafafa; }
    tbody tr.hidden { display: none; }
    .tld { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { text-align: right; }

    .loading { display:flex; align-items:center; gap:8px; color:var(--muted); margin-top: 20px; }
    .spinner { width:16px; height:16px; border:2px solid var(--ring); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }

    footer { margin-top:auto; padding: 32px 0 40px; text-align:center; color:#6b7280; font-size:14px; }

    @media (max-width: 640px) {
      h1 { font-size: 28px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Registrar TLD Price List</h1>
    <p class="sub">Compare 1-year regular registration prices by registrar. Filter as you type.</p>

    <div class="search" role="search">
      <svg aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18.5a7.5 7.5 0 006.15-1.85z" />
      </svg>
      <input id="q" placeholder="Filter by TLD… e.g. .ng or com" aria-label="Filter TLDs" />
      <button class="icon" id="clear" title="Clear">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="summary" id="summary"></div>
    <div class="loading" id="loading" hidden><span class="spinner"></span><span>Loading price data…</span></div>
    <div class="table-wrap">
      <table id="price-table" aria-label="TLD price comparison table">
        <thead>
          <tr id="thead-row">
            <th style="min-width: 160px;">TLD</th>
            <th class="right" style="min-width: 90px;">Max Years</th>
            <!-- Registrar columns will be injected here -->
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer>
      Made with ❤️ by Justice &amp; AI.
    </footer>
  </div>

  <script type="module">
    (async function () {
      let RegLib = null;
      try {
        RegLib = await import('./registrar-pricelist.js');
      } catch (_) { /* bundle not present; fall back to fetching JSON */ }

      const registrars = RegLib?.registrars || [
        { key: 'namecheap', label: 'Namecheap', paths: ['../data/namecheap-prices.json', './data/namecheap-prices.json', '/data/namecheap-prices.json'] },
        { key: 'openprovider', label: 'OpenProvider', paths: ['../data/openprovider-prices.json', './data/openprovider-prices.json', '/data/openprovider-prices.json'] },
        { key: 'nira', label: 'NIRA', paths: ['../data/nira-prices.json', './data/nira-prices.json', '/data/nira-prices.json'] },
      ];

      const $q = document.getElementById('q');
      const $clear = document.getElementById('clear');
      const $theadRow = document.getElementById('thead-row');
      const $tbody = document.getElementById('tbody');
      const $summary = document.getElementById('summary');
      const $loading = document.getElementById('loading');

      // Try multiple base paths so this works when served from repo root or docs/ root
      async function fetchFirst(paths) {
        for (const url of paths) {
          try {
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) throw new Error(String(res.status));
            return await res.json();
          } catch (_) { /* try next */ }
        }
        return null;
      }

      function getCreatePrice(entry) {
        if (!entry) return undefined;
        const rp = entry['regular-price'] || {};
        // Prefer create; fallback to renew when create missing
        if (typeof rp.create === 'number') return rp.create;
        if (typeof rp.renew === 'number') return rp.renew;
        return undefined;
      }

      function fmtPrice(v) {
        return typeof v === 'number' && Number.isFinite(v) ? v.toFixed(2) : '—';
      }

      function buildHeader() {
        registrars.forEach(r => {
          const th = document.createElement('th');
          th.textContent = r.label;
          th.className = 'right';
          th.style.minWidth = '120px';
          $theadRow.appendChild(th);
        });
      }

      function buildRows(index, order) {
        const tlds = Array.from(Object.keys(index)).sort((a, b) => a.localeCompare(b));
        const frag = document.createDocumentFragment();
        tlds.forEach(tld => {
          const tr = document.createElement('tr');
          tr.dataset.tld = tld.toLowerCase();

          const tdTld = document.createElement('td');
          tdTld.textContent = tld;
          tdTld.className = 'tld';
          tr.appendChild(tdTld);

          const tdMax = document.createElement('td');
          tdMax.className = 'right';
          const my = index[tld].maxYears;
          tdMax.textContent = Number.isFinite(my) ? String(my) : '—';
          tr.appendChild(tdMax);

          // Registrar columns in the display order
          order.forEach(key => {
            const td = document.createElement('td');
            td.className = 'right';
            td.textContent = fmtPrice(index[tld].prices[key]);
            tr.appendChild(td);
          });

          frag.appendChild(tr);
        });
        $tbody.textContent = '';
        $tbody.appendChild(frag);
        updateSummary();
      }

      function filterRows(term) {
        const q = (term || '').trim().toLowerCase();
        let visible = 0;
        for (const tr of $tbody.rows) {
          const match = !q || tr.dataset.tld.includes(q);
          tr.classList.toggle('hidden', !match);
          if (match) visible++;
        }
        updateSummary(visible);
      }

      function updateSummary(visibleCount) {
        const total = $tbody.rows.length;
        const visible = typeof visibleCount === 'number' ? visibleCount : total;
        $summary.textContent = `${visible.toLocaleString()} of ${total.toLocaleString()} TLDs`;
      }

      async function init() {
        $loading.hidden = false;
        buildHeader();

        // Load datasets either from bundled library or by fetching JSON files
        let datasets;
        if (RegLib?.datasets) {
          datasets = RegLib.datasets;
        } else {
          const results = await Promise.all(
            registrars.map(r => fetchFirst(r.paths).then(json => ({ key: r.key, data: json })))
          );
          datasets = Object.fromEntries(results.filter(r => r.data).map(r => [r.key, r.data]));
        }

        // Build unified index (prefer library helper if available)
        const index = RegLib?.buildPriceIndex ? RegLib.buildPriceIndex(datasets) : (() => {
          const idx = {};
          const addFrom = (key, data) => {
            if (!data || !data.data) return;
            for (const [tld, entry] of Object.entries(data.data)) {
              if (!idx[tld]) idx[tld] = { maxYears: undefined, prices: {} };
              const my = typeof entry.maxYears === 'number' ? entry.maxYears : undefined;
              if (Number.isFinite(my)) idx[tld].maxYears = Math.max(idx[tld].maxYears || 0, my);
              const p = getCreatePrice(entry);
              if (typeof p === 'number' && Number.isFinite(p)) idx[tld].prices[key] = p;
            }
          };
          addFrom('namecheap', datasets.namecheap);
          addFrom('openprovider', datasets.openprovider);
          addFrom('nira', datasets.nira);
          return idx;
        })();

        // Column display order mirrors header order
        const order = registrars.map(r => r.key);
        buildRows(index, order);
        $loading.hidden = true;

        // Seed filter from URL param if present
        const url = new URL(window.location.href);
        const initial = (url.searchParams.get('q') || '').trim();
        if (initial) {
          $q.value = initial;
          filterRows(initial);
        }

        // Live filtering on input (no Enter keypress needed)
        $q.addEventListener('input', (e) => {
          const val = e.target.value || '';
          // keep URL in sync for shareable filters
          const u = new URL(window.location.href);
          if (val) u.searchParams.set('q', val); else u.searchParams.delete('q');
          history.replaceState({}, '', u);
          filterRows(val);
        });

        $clear.addEventListener('click', () => {
          $q.value = '';
          const u = new URL(window.location.href);
          u.searchParams.delete('q');
          history.replaceState({}, '', u);
          filterRows('');
          $q.focus();
        });
      }

      init();
    })();
  </script>
</body>

</html>
